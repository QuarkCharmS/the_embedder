# RAG Embedder - Upload Repository Job Template
#
# This job clones a Git repository, processes it, and uploads embeddings to Qdrant.
# Each run generates a unique job name and auto-deletes after 5 minutes.
#
# Usage:
#   1. Ensure the rag-embedder-env Secret exists (see secret.yaml)
#   2. Edit REPO_URL and COLLECTION_NAME below
#   3. Apply: kubectl apply -f upload-repo-job.yaml
#   4. Monitor: kubectl get jobs -w
#   5. Check logs: kubectl logs job/rag-upload-repo-<random-id>
#
# The job will automatically be deleted 300 seconds (5 minutes) after completion.

apiVersion: batch/v1
kind: Job
metadata:
  generateName: rag-upload-repo-  # Kubernetes will append random suffix
  namespace: default
spec:
  # Delete job 5 minutes after completion (success or failure)
  ttlSecondsAfterFinished: 300

  # Don't retry on failure
  backoffLimit: 0

  template:
    spec:
      restartPolicy: Never

      # Mount the secret as a volume
      volumes:
        - name: env-config
          secret:
            secretName: rag-embedder-env

      containers:
        - name: rag-cli
          image: letpoquark/rag_embedder:latest
          imagePullPolicy: IfNotPresent

          # Mount the .env file from secret
          volumeMounts:
            - name: env-config
              mountPath: /app/.env
              subPath: .env
              readOnly: true

          # Repository and collection parameters (override these)
          env:
            - name: REPO_URL
              value: "https://github.com/QuarkCharmS/the_chunker.git"
            - name: COLLECTION_NAME
              value: "my-collection"

          command:
            - "python"
            - "-m"
            - "app.cli"
            - "upload"
            - "repo"
            - "$(REPO_URL)"
            - "$(COLLECTION_NAME)"
